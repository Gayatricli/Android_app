package com.example.stressease.Analytics

import android.content.Intent
import android.os.Bundle
import android.util.Log
import android.widget.Button
import android.widget.ImageButton
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.example.stressease.LocalStorageOffline.SharedPreference
import com.example.stressease.R
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.ListenerRegistration

class Summary: AppCompatActivity() {
    private lateinit var tvSummaryTitle: TextView
    private lateinit var tvTotalChats: TextView
    private lateinit var tvTotalMoods: TextView
    private lateinit var tvMostCommonEmotion: TextView
    private lateinit var tvMostCommonMood: TextView
    private lateinit var tvOverallStatus: TextView

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.summary)

        tvSummaryTitle = findViewById(R.id.tvSummaryTitle)
        tvTotalChats = findViewById(R.id.tvTotalChats)
        tvTotalMoods = findViewById(R.id.tvTotalMoods)
        tvMostCommonEmotion = findViewById(R.id.tvMostCommonEmotion)
        tvMostCommonMood = findViewById(R.id.tvMostCommonMood)
        tvOverallStatus = findViewById(R.id.tvOverallStatus)
        val btnBack = findViewById<Button>(R.id.btnBack)
        val btnNext = findViewById<Button>(R.id.btnNext)

        val chatHistory = SharedPreference.loadChatList(this, "chat_history")
        val moodHistory = SharedPreference.loadStringList(this, "mood_history")

        val totalChats = chatHistory.size
        val totalMoods = moodHistory.size


        val emotionCounts = chatHistory.groupingBy { it.emotion }.eachCount()
        val mostCommonEmotion = emotionCounts.maxByOrNull { it.value }?.key ?: "None"


        val moodCounts = moodHistory.groupingBy { it }.eachCount()
        val mostCommonMood = moodCounts.maxByOrNull { it.value }?.key ?: "None"

        val overallStatus = when {
            (emotionCounts["Positive"] ?: 0) > (emotionCounts["Negative"] ?: 0) -> "Mostly Positive üòä"
            (emotionCounts["Negative"] ?: 0) > (emotionCounts["Positive"] ?: 0) -> "Mostly Negative üòü"
            else -> "Mixed Mood ‚öñÔ∏è"
        }
        tvSummaryTitle.text = "Overall Mood & Chat Summary"
        tvTotalChats.text = "Total Chats: $totalChats"
        tvTotalMoods.text = "Total Moods Logged: $totalMoods"
        tvMostCommonEmotion.text = "Most Common Emotion: $mostCommonEmotion"
        tvMostCommonMood.text = "Most Common Mood: $mostCommonMood"
        tvOverallStatus.text = "Overall Status: $overallStatus"
        btnBack.setOnClickListener {
            startActivity(Intent(this, ReportsActivity::class.java))
            finish()
        }
        btnNext.setOnClickListener {
            startActivity(Intent(this, Leaderboard::class.java))
            finish()
        }
    }

}

class SuggestionsActivity : AppCompatActivity() {

    // UI Components
    private lateinit var tvEmotion: TextView
    private lateinit var tvSummary: TextView
    private lateinit var tvMotivation: TextView
    private lateinit var tvSuggestions: TextView
    private lateinit var btnBack: ImageButton
    private lateinit var btnSave: ImageButton
    private lateinit var tvConfidence: TextView

    // Firebase
    private lateinit var db: FirebaseFirestore
    private lateinit var auth: FirebaseAuth
    private var insightsListener: ListenerRegistration? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_suggestion)

        // Initialize Firebase
        auth = FirebaseAuth.getInstance()
        db = FirebaseFirestore.getInstance()

        // Bind UI elements
        tvEmotion = findViewById(R.id.tvEmotion)
        tvSummary = findViewById(R.id.tvSummary)
        tvMotivation = findViewById(R.id.tvMotivation)
        tvSuggestions = findViewById(R.id.tvSuggestions)
        tvConfidence = findViewById(R.id.tvEmotion) // same card, appending confidence info
        btnBack = findViewById(R.id.btnBack)
        btnSave = findViewById(R.id.btnSave)

        // Navigation
        btnBack.setOnClickListener { finish() }
        btnSave.setOnClickListener { saveCurrentInsights() }

        // üîπ Listen for live Firestore updates from Flask
        loadAIInsightsFromFirestore()
    }

    override fun onDestroy() {
        super.onDestroy()
        insightsListener?.remove()
    }

    /**
     * Load the latest Flask-generated AI insights stored in Firestore
     * Document: users/{uid}/ai_insights/latest
     */
    private fun loadAIInsightsFromFirestore() {
        val userId = auth.currentUser?.uid ?: return

        val insightsRef = db.collection("users")
            .document(userId)
            .collection("ai_insights")
            .document("latest")

        // Real-time listener ‚Üí automatically refreshes after Flask update
        insightsListener = insightsRef.addSnapshotListener { doc, e ->
            if (e != null) {
                Log.e("SuggestionsActivity", "‚ùå Firestore listener failed: ${e.message}")
                Toast.makeText(this, "Error loading insights.", Toast.LENGTH_SHORT).show()
                return@addSnapshotListener
            }

            if (doc == null || !doc.exists()) {
                tvSummary.text = "No insights yet ‚Äî complete a quiz to generate your AI analysis!"
                return@addSnapshotListener
            }

            // Extract values from Firestore
            val emotion = doc.getString("dominant_emotion") ?: "Neutral"
            val summary = doc.getString("summary") ?: "No summary available."
            val confidence = doc.getDouble("confidence_score") ?: 0.0
            val motivation = doc.getString("motivation_quote") ?: "Stay positive and keep going üí™"
            val suggestionsList = doc.get("suggestions") as? List<String> ?: emptyList()

            // Format suggestions as bullet points
            val suggestionsFormatted = suggestionsList.joinToString("\n‚Ä¢ ", prefix = "‚Ä¢ ")

            // üü£ Update the UI
            tvEmotion.text = "Dominant Emotion: $emotion"
            tvSummary.text = summary
            tvMotivation.text = motivation
            tvSuggestions.text = suggestionsFormatted

            // Append confidence to emotion card
            val confidenceText = "\n\nConfidence Score: ${String.format("%.0f", confidence)}%"
            tvEmotion.append(confidenceText)

            Log.d("SuggestionsActivity", "‚úÖ Loaded insights for $userId ‚Üí $emotion ($confidence%)")
        }
    }

    /**
     * Manually saves currently displayed insights into user's saved_insights/
     * So user can revisit past AI summaries.
     */
    private fun saveCurrentInsights() {
        val userId = auth.currentUser?.uid ?: return

        val data = mapOf(
            "emotion" to tvEmotion.text.toString(),
            "summary" to tvSummary.text.toString(),
            "motivation" to tvMotivation.text.toString(),
            "suggestions" to tvSuggestions.text.toString(),
            "savedAt" to System.currentTimeMillis()
        )

        db.collection("users")
            .document(userId)
            .collection("saved_insights")
            .add(data)
            .addOnSuccessListener {
                Toast.makeText(this, "üíæ Insights saved successfully!", Toast.LENGTH_SHORT).show()
            }
            .addOnFailureListener { e ->
                Toast.makeText(this, "‚ùå Save failed: ${e.message}", Toast.LENGTH_SHORT).show()
                Log.e("SuggestionsActivity", "Error saving insights", e)
            }
    }
}